<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>718校内赛技术报告 | 全之の博客</title><meta name="author" content="ZU Quanzhi"><meta name="copyright" content="ZU Quanzhi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="此篇博客用于记录校内赛的技术细节和感悟（屎山预警！！！）"><meta property="og:type" content="article"><meta property="og:title" content="718校内赛技术报告"><meta property="og:url" content="https://blog.zuquanzhi.top/2023/11/27/24084/index.html"><meta property="og:site_name" content="全之の博客"><meta property="og:description" content="此篇博客用于记录校内赛的技术细节和感悟（屎山预警！！！）"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.zuquanzhi.top/img/head.jpg"><meta property="article:published_time" content="2023-11-27T07:29:11.000Z"><meta property="article:modified_time" content="2025-09-17T13:30:58.684Z"><meta property="article:author" content="ZU Quanzhi"><meta property="article:tag" content="寻迹车 蓝牙"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.zuquanzhi.top/img/head.jpg"><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://blog.zuquanzhi.top/2023/11/27/24084/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: ZU Quanzhi","link":"链接: ","source":"来源: 全之の博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"718校内赛技术报告",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-09-17 21:30:58"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="preload" href="/css/transpancy.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><link rel="preload" href="/css/mouse.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="/css/transpancy.css"></noscript><noscript><link rel="stylesheet" href="/css/mouse.css"></noscript><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="全之の博客" type="application/atom+xml"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/head.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/cloud/"><i class="fa-fw fas fa-cloud"></i><span> Cloud</span></a></div><div class="menus_item"><a class="site-page" href="/Pictures/"><i class="fa-fw fas fa-images"></i><span> Pictures</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background:0 0"><nav id="nav"><span id="blog-info"><a href="/" title="全之の博客"><span class="site-name">全之の博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/cloud/"><i class="fa-fw fas fa-cloud"></i><span> Cloud</span></a></div><div class="menus_item"><a class="site-page" href="/Pictures/"><i class="fa-fw fas fa-images"></i><span> Pictures</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">718校内赛技术报告</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-27T07:29:11.000Z" title="发表于 2023-11-27 15:29:11">2023-11-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-17T13:30:58.684Z" title="更新于 2025-09-17 21:30:58">2025-09-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%BA%E5%99%A8%E4%BA%BA-%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">机器人/计算机视觉</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="718校内赛技术报告"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>此篇博客用于记录校内赛的技术细节和感悟（屎山预警！！！）</p><span id="more"></span><h1 id="1-硬件"><a href="#1-硬件" class="headerlink" title="1. 硬件"></a>1. 硬件</h1><h2 id="1-1-红外对管"><a href="#1-1-红外对管" class="headerlink" title="1.1 红外对管"></a>1.1 红外对管</h2><p>排布见下图：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="2.png" alt="红外对管排布"></p><p>其中4 5作为循迹灯，其余全部用于路口判断。</p><h3 id="1-1-1-循迹"><a href="#1-1-1-循迹" class="headerlink" title="1.1.1 循迹"></a>1.1.1 循迹</h3><p>利用左右循迹灯实现循迹，使用了PID算法，只使用了P和D，详细说明见2.1。</p><h3 id="1-1-2-路口判断逻辑"><a href="#1-1-2-路口判断逻辑" class="headerlink" title="1.1.2 路口判断逻辑"></a>1.1.2 路口判断逻辑</h3><p>利用1 2 3 0四个红外对管实现对路口的识别。</p><p>另外规定ADC的值&gt;1900为完全踩上线，ADC的值小于lowx为完全没踩上线，ADC的值大于lowx+200（需要大些）为正在踩上线。</p><p>我们对路口的分类如下：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="1.png" alt="公式"></p><h2 id="1-2-机械臂"><a href="#1-2-机械臂" class="headerlink" title="1.2 机械臂"></a>1.2 机械臂</h2><p>构成：亚克力板，三个MG90S舵机，胶带，热熔胶，夹子，螺丝，螺母。</p><p>自由度：3</p><p>设计想法：为了便于能量块的夹取和定点投放</p><h1 id="2-软件"><a href="#2-软件" class="headerlink" title="2. 软件"></a>2. 软件</h1><p>注：此部分主要内容及解释都在代码注释中</p><h2 id="2-1-宏及全局变量"><a href="#2-1-宏及全局变量" class="headerlink" title="2.1 宏及全局变量"></a>2.1 宏及全局变量</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PWM.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_usart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AD.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x_it.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> kp 0.90     </span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> kd -80      </span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> high1 2100</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> low1 1800</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> high2 2400</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> low2  2000</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> delaytime 200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换通道个数</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NOFCHANEL 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILTER_SIZE 5  </span></span><br><span class="line"></span><br><span class="line"><span class="type">int16_t</span> filtered_AD0[FILTER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int16_t</span> filtered_AD1[FILTER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int16_t</span> filtered_AD2[FILTER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int16_t</span> filtered_AD3[FILTER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int16_t</span> filtered_AD4[FILTER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int16_t</span> filtered_AD5[FILTER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="comment">//用于储存ADC返回值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 ADC1 转换的电压值通过 DMA 方式传到 SRAM</span></span><br><span class="line"><span class="keyword">extern</span> __IO <span class="type">uint16_t</span> ADC_ConvertedValue[NOFCHANEL];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 局部变量，用于保存转换计算后的电压值</span></span><br><span class="line"><span class="type">float</span> ADC_ConvertedValueLocal[NOFCHANEL];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int16_t</span> et = <span class="number">0</span>;</span><br><span class="line"><span class="type">int16_t</span> det = <span class="number">0</span>;</span><br><span class="line"><span class="type">int16_t</span> temp = <span class="number">0</span>;</span><br><span class="line"><span class="type">int16_t</span> wucha =<span class="number">0</span>;</span><br><span class="line"><span class="comment">//PID中变量，用于更新误差等数据</span></span><br></pre></td></tr></table></figure><h2 id="2-2-主函数及初始化"><a href="#2-2-主函数及初始化" class="headerlink" title="2.2 主函数及初始化"></a>2.2 主函数及初始化</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   </span><br><span class="line">    USART_Config();</span><br><span class="line">    TIM1_CH4_PWM_Init();</span><br><span class="line">    PWM_Init();</span><br><span class="line">    AD_Init();</span><br><span class="line">    wucha =AD_Value[<span class="number">4</span>]-AD_Value[<span class="number">5</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;7&#x27;</span>==ucTemp)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                pid();</span><br><span class="line">                <span class="comment">// 在特殊路口执行特殊操作</span></span><br><span class="line">                <span class="keyword">if</span> (isTIntersection()) &#123;</span><br><span class="line">                    handleTIntersection();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isLeftTurn()) &#123;</span><br><span class="line">                    handleLeftTurn();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isRightTurn()) &#123;</span><br><span class="line">                    handleRightTurn();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isRoundabout()) &#123;</span><br><span class="line">                    handleRoundabout();</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (isRound()) &#123;</span><br><span class="line">                    handleROUND();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&#x27;6&#x27;</span>==ucTemp	)</span><br><span class="line">                &#123;Motor_Run(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                 Motor_Run(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">                 <span class="keyword">break</span>;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;5&#x27;</span>==ucTemp)</span><br><span class="line">        &#123;<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BlueTeeth();</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&#x27;6&#x27;</span>==ucTemp	)</span><br><span class="line">            &#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;8&#x27;</span>==ucTemp)</span><br><span class="line">        &#123;<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            pid();</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&#x27;6&#x27;</span>==ucTemp)</span><br><span class="line">            &#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-3-PID"><a href="#2-3-PID" class="headerlink" title="2.3 PID"></a>2.3 PID</h2><p>我们的小车只使用了P和D，因为我们实现闭环的不是加速度，所以不需要用积分项去逼近目标位置。P好理解，就是正比于误差的量；但P也不能太小，否则P太小的话转弯太慢，导致S弯绕不过去。D作为斜率可以通过抑制P的趋势来实现消抖的功能。</p><p>理论学习如下：</p><ul><li>整体思路：ADC采样—&gt;对ADC采样数据的数学处理—&gt;对得到的数据进行PID算法运算—&gt;赋值给ccr调整pwm波输出占空比驱动电机。循环此过程则可实现速度闭环实现直角弯道除外的赛道。</li><li>方案：两灯and三灯。但考虑到两灯操作更简单，对硬件兼容性更高。最终采用两灯方案。</li><li>理论理解：</li></ul><p>尽可能的扩大两个参数的值域：ADC数学处理获得值、小车识别黑线范围。针对第一个参数，当此值变化范围很大时，可以获得更高的精度调控；针对第二个参数，当此值变化范围很大时，可以扩大小车的“视野”，即使已经偏线也可以回归正轨。</p><p>归根结底，重点在于数学处理。</p><ul><li>实操理解：</li></ul><p>@针对采样：</p><p><strong>重要参数：</strong>单个采样范围及变化趋势，单个采样值。</p><p><strong>单个采样范围及变化趋势：</strong>非常有限，几乎不触及黑线采样值变化很小，但一接近黑线立即成指数增长。</p><p><strong>单个采样值：</strong>几百个体差异到约2300的原始值。但转化为电压值之后仅为 0~3.3，大量数据被压缩，损失了很多精度，最终决定采用原始值进行操作。</p><p><strong>误差来源</strong>：环境红外线影响，红外对管个体差异，红外对管彼此距离，红外对管对地距离。</p><p><strong>环境红外线影响</strong>：很大。非常影响红外对管采集数据。最终解决办法有两种，一是在每个红外对管四周缠上黑胶布，用以反射环境红外线并聚合红外对管发出的红外线；二是在代码中初始化过程中消除环境误差并不需要测得，但随着小车运动导致的位置改变，环境误差在变化，而我们只消除了开始的误差，我们选择使用动态消除误差。</p><p><strong>红外对管个体差异：</strong>不同红外对管的峰值大致相同，但最低值各有千秋。有的一两百，有的却五六百。考虑到对ADC采样数据进行处理时，个体误差的存在会影响很多计算结果造成两个灯调节作用差别很大。故必须消除。最终我们采用个体采样值域大的红外对管，以输出更加灵敏的值，并在代码中在初始化过程中，连同环境误差一起消除。</p><p><strong>红外对管彼此距离：</strong>主要影响两点，一是识别范围，二是数学处理时产生漏洞。对于第一点，两灯距离太小时，识别范围就太小，小车遇到稍抖一点的弯路时极易偏线，但两灯距离过大时，就相当于允许小车有一定程度的偏线，造成循迹不流畅。对于第二点，若两灯距离过小，此时可以忽略个体误差，但同时ADC数学处理获得值值域很小，调节精度或说范围很小，若两灯距离过大，两灯之间会留出一个处理值为0的空白区允许小车一定程度偏线，这是我们不希望看到的。</p><p><strong>红外对管对地距离</strong>：主要影响红外对管的采样值域。对地距离过低时红外对管接收不到反射光，采样值很低，对地距离过高时很受环境光干扰，接收红外线很多，采样值很高，通过打印波形图来观察何对地距离红外对管的检测距离最大，以及采样值域最大。</p><p>@针对数学处理：</p><p><strong>处理参数：</strong>识别范围，输出值。</p><p><strong>识别范围：</strong>即小车的“视野”，能够允许偏线程度最大的情况下依然可以回归正轨。</p><p><strong>输出值：</strong>作为偏差，进行PID运算后，改变ccr来改变电机占空比。</p><p><strong>处理方法与消除误差：</strong></p><p>缺少能够作为条件的判断，所以只有让两灯采样值相减，同时让两灯在同一环境下初始化，记录两灯差值，然后代入程序中来消除个体误差和环境误差，然后调用ADC数据处理函数。</p><p>@针对PID：</p><p>本次任务中采用位置式PID，且用到P与D参与运算。</p><p>采用PD系统调节原因：通过P进行主导线形控制，通过D来计算未来趋势抑制系统震荡，即通过PD系统获得更快的反应速度。符合循迹需求。</p><p>输入值：实时计算ADC数学处理获得值与目标值0的差值</p><p>输出值：除了初始占空比以外的用于控制电机的pwm</p><p>偏差：ADC数学处理获得值与目标值0的差值，用于P计算</p><p>二次偏差：前后两次偏差的差值，用于D计算</p><p>调参注意：P过小调节作用小，P过大造成过冲系统震荡。D过小调节作用小，D过大会放大系统趋势的影响，使系统震荡。</p><p>调参顺序：先设D=0，调P，从0逐渐增大，直到系统震荡。再调D使其逐渐增大，直到系统震荡。之后进行微调，直到系统稳定。</p><p>@针对电机控制：</p><p>调节方式：对两边电机附PID不同运算值，以达到使两侧不同性能电机具有相同效果的调节作用。</p><p>调节精度及限制：</p><p>考虑到可供调节的ccr范围为0~500( 有点小，占空比的相对调节精度小），但考虑到对循迹小车来讲500的调节范围够用，所以没改，但后来调车发现问题，发现有些曲率较大的弯转不过去，起初认为是P设的过小，但经过数学运算后发现问题是数值溢出，即能转过这个弯路的PID处理值没发挥出它的作用，因为溢出下限即占空比为0，溢出上限即占空比为100，所以最终采用【循迹电机反转函数】的使用，使溢出值得到充分利用。事实上增大ccr的可操作区间亦可。</p><p>初始值设置：一开始设置为50%占空比，因为考虑到想使PID调节具有对称性。事实效果很好，循迹很丝滑，但后来考虑到走直线速度较慢，故逐渐增大初始占空比，再具体进行调参。</p><p>详细解释见下方代码注释。</p><h3 id="2-3-1-PID代码"><a href="#2-3-1-PID代码" class="headerlink" title="2.3.1 PID代码"></a>2.3.1 PID代码</h3><h4 id="2-3-1-1-PID基本原理"><a href="#2-3-1-1-PID基本原理" class="headerlink" title="2.3.1.1 PID基本原理"></a>2.3.1.1 PID基本原理</h4><p><strong>PID详解</strong></p><ul><li><strong>比例增益（P）：</strong> 比例部分根据当前误差的大小调整输出。如果误差较大，比例增益会产生更大的输出变化，以更快地减小误差。然而，如果比例增益设置得太大，系统可能会变得不稳定。</li><li><strong>积分时间（I）：</strong> 积分部分考虑了误差随时间的积累。它用于消除系统稳态误差，因为它会持续增加控制输出，直到误差为零。但如果积分时间设置得太大，可能导致系统的超调或振荡。</li><li><strong>微分时间（D）：</strong> 微分部分考虑了误差变化的速度。它可以帮助系统抑制振荡，因为它对误差变化的速度进行响应，减小输出的变化速度。然而，如果微分时间设置得太大，可能会导致系统对噪声敏感。</li></ul><p><strong>PID算法基本原理</strong></p><p><em>PID算法的执行流程是非常简单的，即利用反馈来检测偏差信号，并通过偏差信号来控制被控量。而控制器本身就是比例、积分、微分三个环节的加和。</em></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="3.png" alt="公式"></p><p>根据上图我们考虑在某个特定的时刻t，此时输入量为rin(t)，输出量为rout(t)，于是偏差就可计算为err(t)=rin(t)-rout(t)。于是PID的基本控制规律就可以表示为如下公式：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="4.png" alt="公式"><br><em>其中Kp为比例带，TI为积分时间，TD为微分时间。</em></p><p>PID算法离散化</p><p>由于在计算机上应实现离散化问题，我们对比例，积分，微分特性做简单说明。</p><p>比例就是用来对系统的偏差进行反应，所以只要存在偏差，比例就会起作用。积分主要是用来消除静差，所谓静差就是指系统稳定后输入输出之间依然存在的差值，而积分就是通过偏差的累计来抵消系统的静差。而微分则是对偏差的变化趋势做出反应，根据偏差的变化趋势实现超前调节，提高反应速度。</p><p>在实现离散前，我们假设系统采样周期为T。假设我们检查第K个采样周期，很显然系统进行第K次采样。此时的偏差可以表示为err(K)=rin(K)-rout(K)，那么积分就可以表示为：err(K)+ err(K+1)+┈┈，而微分就可以表示为：(err(K)- err(K-1))/T。于是我们可以将第K次采样时，PID算法的离线形式表示为：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="5.png" alt="公式"><br>这就是所谓的PID算法离散描述公式。还有一个增量型PID算法，下面来推导一下。<br>上面的公式描述了第k哥采样周期的结果，那么前一时刻也就是k-1哥采样周期可表示为：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="6.png" alt="公式"><br>那么我们再来说第K个采样周期的增量，很显然就是U(k)-U(k-1)。于是我们用第k个采样周期公式减去第k-1个采样周期的公式，就得到了增量型PID算法的表示公式：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="7.png" alt="公式"></p><p>当然，增量型PID必须记得一点，就是在记住U(k)=U(k-1)+∆U(k)</p><p><strong>PID控制器基本实现</strong></p><p>完成了离散化后，我们就可以来实现它了。已经用离散化的数据公式表示出来后，再进型计算机编程已经不是问题了。接下来我们就使用C语言分别针对位置型公式和增量型公式来具体实现。</p><p>位置型PID简单实现</p><p>位置型PID的实现就是以前面的位置型公式为基础。这一节我们只是完成最简单的实现，也就是将前面的离散位置型PID公式的计算机语言化。<br>首先定义PID对象的结构体：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*定义结构体和公用体*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> setpoint;       <span class="comment">//设定值</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> proportiongain;     <span class="comment">//比例系数</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> integralgain;      <span class="comment">//积分系数</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> derivativegain;    <span class="comment">//微分系数</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> lasterror;     <span class="comment">//前一拍偏差</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> result; <span class="comment">//输出值</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> integral;<span class="comment">//积分值</span></span><br><span class="line"></span><br><span class="line">&#125;PID;</span><br></pre></td></tr></table></figure><p>接下来<strong>实现PID控制器：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">PIDRegulation</span><span class="params">(PID *vPID, <span class="type">float</span> processValue)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> thisError;</span><br><span class="line"></span><br><span class="line">  thisError=vPID-&gt;setpoint-processValue;</span><br><span class="line"></span><br><span class="line">  vPID-&gt;integral+=thisError;</span><br><span class="line"></span><br><span class="line">  vPID-&gt;result=vPID-&gt;proportiongain*thisError+vPID-&gt;integralgain*vPID-&gt;integral+vPID-&gt;derivativegain*(thisError-vPID-&gt;lasterror);</span><br><span class="line"></span><br><span class="line">  vPID-&gt;lasterror=thisError;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这就实现了一个最简单的位置型PID控制器，当然没有考虑任何干扰条件，仅仅只是对数学公式的计算机语言化。</p><p><strong>增量型PID简单实现</strong></p><p>增量型PID的实现就是以前面的增量型公式为基础。这一节我们只是完成最简单的实现，也就是将前面的离散增量型PID公式的计算机语言化。</p><p>首先定义PID对象的结构体：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*定义结构体和公用体*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> setpoint;       <span class="comment">//设定值</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> proportiongain;     <span class="comment">//比例系数</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> integralgain;      <span class="comment">//积分系数</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> derivativegain;    <span class="comment">//微分系数</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> lasterror;     <span class="comment">//前一拍偏差</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> preerror;     <span class="comment">//前两拍偏差</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> deadband;     <span class="comment">//死区</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> result; <span class="comment">//输出值</span></span><br><span class="line"></span><br><span class="line">&#125;PID;</span><br></pre></td></tr></table></figure><p><strong>位置型PID控制器的基本特点：</strong></p><ul><li>位置型PID控制的输出与整个过去的状态有关，用到了偏差的累加值，容易产生累积偏差。</li><li>位置型PID适用于执行机构不带积分部件的对象。</li><li>位置型的输出直接对应对象的输出，对系统的影响比较大。</li></ul><p><strong>增量型PID控制器的基本特点：</strong></p><ul><li>增量型PID算法不需要做累加，控制量增量的确定仅与最近几次偏差值有关，计算偏差的影响较小。</li><li>增量型PID算法得出的是控制量的增量，对系统的影响相对较小。</li><li>采用增量型PID算法易于实现手动到自动的无扰动切换。</li></ul><h4 id="2-3-1-2-最终代码实现"><a href="#2-3-1-2-最终代码实现" class="headerlink" title="2.3.1.2 最终代码实现"></a>2.3.1.2 最终代码实现</h4><p>代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">pid</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取滤波后的值</span></span><br><span class="line">    <span class="type">int16_t</span> filtered_AD4_value = getFilteredValue(filtered_AD4);</span><br><span class="line">    <span class="type">int16_t</span> filtered_AD5_value = getFilteredValue(filtered_AD5);</span><br><span class="line"></span><br><span class="line">    et = filtered_AD4_value - filtered_AD5_value - wucha;</span><br><span class="line">    det = et - temp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((kp) * et &lt; <span class="number">200</span>) &amp;&amp; ((kp) * et &gt; <span class="number">-200</span>)) &#123;</span><br><span class="line">        MotorControl(FRONT, <span class="number">1000</span> + (kp)/<span class="number">2</span> * et - kd * det);</span><br><span class="line">    &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (kp * et &lt;= <span class="number">-50</span>) &#123;  </span><br><span class="line">        MotorControl(LEFT, <span class="number">-100</span> - kp * et + kd * det);  </span><br><span class="line">        MotorControl(FRONT, <span class="number">1000</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (kp* et &gt;= <span class="number">50</span>) &#123;</span><br><span class="line">        MotorControl(FRONT, <span class="number">1000</span>);</span><br><span class="line">        MotorControl(RIGHT, kp * et - <span class="number">100</span> - kd * det);</span><br><span class="line">    &#125;</span><br><span class="line">    temp = et;<span class="comment">//pid输出值暂存</span></span><br><span class="line"></span><br><span class="line">    updateFilter(filtered_AD4, AD_Value[<span class="number">4</span>]);</span><br><span class="line">    updateFilter(filtered_AD5, AD_Value[<span class="number">5</span>]);</span><br><span class="line">    <span class="comment">//更新滤波输入，减小误差</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-4-路口识别"><a href="#2-4-路口识别" class="headerlink" title="2.4 路口识别"></a>2.4 路口识别</h2><p>在本节中，详细讲讲判断环岛及真假环岛的逻辑（即连续两次左/右T型路口，左手定则为右T型，右手定则为左T型），其余路口都较为简单，不多赘述。</p><p>以左手定则走右环岛为例，首先不论环岛的真假，先判断连续两个右T型路口。我们设置了标志位flag（详见2.2主函数），在每次识别到非右T型路口时将其置零；在判断到右T型路口时将其取反，然后在下面写个若flag为0就进环岛函数的if，这样就实现了判断连续两个右T型路口。（详见2.4.1，2.4.3）</p><p>接着就是环岛的走法及判断环岛的真假。</p><p>(1) 环岛走法的大致逻辑就是，首先在第二个右T型路口右拐进环岛，然后识别环岛内第一个路口为右拐（第一个while，右拐后跳出），然后识别第二个路口为右拐（第二个while，右拐后跳出），然后识别第三个路口为T字型路口（第三个while，右拐后跳出），并return0，出函数再把flag置0，防止其一直走环岛。</p><p>(2) 判断环岛真假的大致逻辑是，在上述依次识别三个路口过程中，只要有一个识别到的路口与我们设定的路口不一致，就立马结束整个环岛函数并return相应的值（比如第一个路口不一致了就返回1，第二个不一致就返回2，第三个不一致就返回3），然后在循迹函数里做相应的处理。这里的处理也好理解，先让小车转180度，然后用switch case语句，从case3开始往case1写，内容便是按原路返回，然后在最初始的路口右拐。</p><p>比较有趣的是，我们发现在左手定则的大前提下，如果在同一个路口连续使用偶数次右手定则，则完全不会破坏左手定则的逻辑，换句话说，同一路口的偶数次右手定则等价于1次左手定则。</p><p>当然，从假环岛出来后还得把flag置1，这样又能解决走右T型+右环岛时进不了环岛的问题。</p><p>其代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否为断头路</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isRound</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (AD_Value[<span class="number">7</span>] &lt; <span class="number">2000</span>	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理断头路的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleROUND</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	  performAction(BACK_ACTION, <span class="number">300</span>);</span><br><span class="line">    performAction(LEFT_ACTION, <span class="number">1300</span>);</span><br><span class="line">	 performAction(LEFT_ACTION, <span class="number">900</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为 T 字灯特殊路口</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isTIntersection</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (AD_Value[<span class="number">2</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">0</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">1</span>] &lt; low1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 T 字灯特殊路口的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleTIntersection</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">	  performAction(STOP_ACTION, <span class="number">500</span>);</span><br><span class="line">	  <span class="comment">//performAction(BACK_ACTION, 300);</span></span><br><span class="line">    performAction(FRONT_ACTION, <span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为左拐路口</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isLeftTurn</span><span class="params">(<span class="type">void</span>)</span> &#123; </span><br><span class="line">	<span class="keyword">return</span> (AD_Value[<span class="number">2</span>] &gt; high2 &amp;&amp; AD_Value[<span class="number">0</span>] &lt; low2 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为右拐路口</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isRightTurn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (AD_Value[<span class="number">2</span>] &lt; low1 &amp;&amp; AD_Value[<span class="number">0</span>] &gt; high1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理左拐路口的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleLeftTurn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  performAction(STOP_ACTION, <span class="number">500</span>);  </span><br><span class="line">	<span class="comment">//performAction(BACK_ACTION, 300);</span></span><br><span class="line">    performAction(LEFT_ACTION, <span class="number">1400</span>);</span><br><span class="line">	 performAction(FRONT_ACTION, <span class="number">500</span>);</span><br><span class="line">    pid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理右拐路口的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRightTurn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    performAction(STOP_ACTION, <span class="number">500</span>);</span><br><span class="line">	  <span class="comment">//performAction(BACK_ACTION, 300);</span></span><br><span class="line">    performAction(RIGHT_ACTION, <span class="number">1500</span>);</span><br><span class="line">	  performAction(FRONT_ACTION, <span class="number">500</span>);</span><br><span class="line">     pid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为环岛</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isRoundabout</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (AD_Value[<span class="number">2</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">0</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">0</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">1</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">4</span>] &gt; high1 &amp;&amp; AD_Value[<span class="number">5</span>] &gt; high1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理进入环岛的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoundabout</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    performAction(STOP_ACTION, <span class="number">500</span>);</span><br><span class="line">    performAction(FRONT_ACTION, <span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>  <span class="title function_">CROSS_JUDG</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">		<span class="type">int</span> a=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(AD_Value[<span class="number">1</span>]&gt;<span class="number">2000</span>&amp;&amp;AD_Value[<span class="number">2</span>]&gt;<span class="number">2000</span>)</span><br><span class="line">     &#123;a=<span class="number">1</span>;&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(AD_Value[<span class="number">1</span>]&gt;<span class="number">2000</span>&amp;&amp;AD_Value[<span class="number">0</span>]&gt;<span class="number">2000</span>)</span><br><span class="line">			&#123;a=<span class="number">2</span>;&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(AD_Value[<span class="number">1</span>]&gt;<span class="number">2000</span>&amp;&amp;AD_Value[<span class="number">0</span>]&gt;<span class="number">2000</span>&amp;&amp;AD_Value[<span class="number">2</span>]&gt;<span class="number">2000</span>)</span><br><span class="line">			&#123;a=<span class="number">3</span>;&#125;</span><br><span class="line">		<span class="keyword">switch</span>(a)</span><br><span class="line">			&#123; </span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				      <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				     MoveDirection(LEFT);</span><br><span class="line">			       Delay_s(<span class="number">1</span>);</span><br><span class="line">			       <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				     MoveDirection(RIGHT);</span><br><span class="line">			       Delay_s(<span class="number">1</span>);</span><br><span class="line">			       <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				     MoveDirection(RIGHT);</span><br><span class="line">			       Delay_s(<span class="number">1</span>);</span><br><span class="line">			       <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-5-蓝牙"><a href="#2-5-蓝牙" class="headerlink" title="2.5 蓝牙"></a>2.5 蓝牙</h2><p>蓝牙这块比较简单，只是一个简单的通信协议，其中给i赋的值都是ASCII码，然后在手机的按键里设置相应的字符即可。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">BlueTeeth</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;1&#x27;</span> == ucTemp)<span class="comment">//前进</span></span><br><span class="line">    &#123;</span><br><span class="line">        MoveDirection(FRONT);</span><br><span class="line">        <span class="comment">//	ucTemp = &#x27;0&#x27;;</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;0&#x27;</span> == ucTemp)<span class="comment">//松开手机上的按键就让其停下</span></span><br><span class="line">            &#123;</span><br><span class="line">                MoveDirection(STOP);</span><br><span class="line">                ucTemp = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;2&#x27;</span> == ucTemp)<span class="comment">//后退</span></span><br><span class="line">    &#123;</span><br><span class="line">        MoveDirection(BACK);</span><br><span class="line">        <span class="comment">//ucTemp = &#x27;0&#x27;;</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;0&#x27;</span> == ucTemp)<span class="comment">//松开手机上的按键就让其停下</span></span><br><span class="line">            &#123;</span><br><span class="line">                MoveDirection(STOP);</span><br><span class="line">                ucTemp = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;3&#x27;</span> == ucTemp)<span class="comment">//左转</span></span><br><span class="line">    &#123;</span><br><span class="line">        MoveDirection(LEFT);</span><br><span class="line">        <span class="comment">//ucTemp = &#x27;0&#x27;;</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;0&#x27;</span> == ucTemp)<span class="comment">//松开手机上的按键就让其停下</span></span><br><span class="line">            &#123;</span><br><span class="line">                MoveDirection(STOP);</span><br><span class="line">                ucTemp = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;4&#x27;</span> == ucTemp)<span class="comment">//右转</span></span><br><span class="line">    &#123;</span><br><span class="line">        MoveDirection(RIGHT);</span><br><span class="line">        <span class="comment">//ucTemp = &#x27;0&#x27;;</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;0&#x27;</span> == ucTemp)<span class="comment">//松开手机上的按键就让其停下</span></span><br><span class="line">            &#123;</span><br><span class="line">                MoveDirection(STOP);</span><br><span class="line">                ucTemp = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-电机控制"><a href="#2-6-电机控制" class="headerlink" title="2.6 电机控制"></a>2.6 电机控制</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制电机运行</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MotorControl</span><span class="params">(Direction direction, <span class="type">int</span> speed)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">        <span class="keyword">case</span> FRONT:</span><br><span class="line">            left_up();</span><br><span class="line">            right_up();</span><br><span class="line">            Motor_Run(<span class="number">0</span>,speed);</span><br><span class="line">            Motor_Run(<span class="number">1</span>,speed);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACK:</span><br><span class="line">            left_down();</span><br><span class="line">            right_down();</span><br><span class="line">            Motor_Run(<span class="number">0</span>,speed);</span><br><span class="line">            Motor_Run(<span class="number">1</span>,speed);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LEFT:</span><br><span class="line">            left_down();</span><br><span class="line">            right_up();</span><br><span class="line">            Motor_Run(<span class="number">0</span>,speed);</span><br><span class="line">            Motor_Run(<span class="number">1</span>,speed);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RIGHT:</span><br><span class="line">            left_up();</span><br><span class="line">            right_down();</span><br><span class="line">            Motor_Run(<span class="number">0</span>,speed);</span><br><span class="line">            Motor_Run(<span class="number">1</span>,speed);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> STOP:</span><br><span class="line">            left_up();</span><br><span class="line">            right_up();</span><br><span class="line">            Motor_Run(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">            Motor_Run(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//控制轮子正反转</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">performAction</span><span class="params">(ActionType action, <span class="type">int</span> duration)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">        <span class="keyword">case</span> STOP_ACTION:</span><br><span class="line">            MotorControl(STOP, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FRONT_ACTION:</span><br><span class="line">            MotorControl(FRONT, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACK_ACTION:</span><br><span class="line">            MotorControl(BACK, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LEFT_ACTION:</span><br><span class="line">            MotorControl(LEFT, <span class="number">1300</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RIGHT_ACTION:</span><br><span class="line">            MotorControl(RIGHT, <span class="number">1300</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Delay_ms(duration);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//控制轮子旋转90°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MoveDirection</span><span class="params">(Direction direction)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">        <span class="keyword">case</span> FRONT:</span><br><span class="line">            MotorControl(FRONT, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACK:</span><br><span class="line">            MotorControl(BACK, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LEFT:</span><br><span class="line">            MotorControl(LEFT, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RIGHT:</span><br><span class="line">            MotorControl(RIGHT, <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> STOP:</span><br><span class="line">            MotorControl(STOP, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">轮子的直接控制</span><br></pre></td></tr></table></figure><p>这一部分的代码主要是电机四个轮子的直接控制封装，由于左右两侧的轮子分别可以看作统一步调，故可以调整电机参数后统一输出PWM，达到同步效果。（底层封装略）</p><h2 id="2-7机械臂"><a href="#2-7机械臂" class="headerlink" title="2.7机械臂"></a>2.7机械臂</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Servo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;NeoSWSerial.h&quot;</span></span></span><br><span class="line">NeoSWSerial <span class="title function_">mySerial</span><span class="params">(<span class="number">12</span>, <span class="number">13</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVOS      (4)     <span class="comment">// 机械臂需要的舵机个数</span></span></span><br><span class="line"></span><br><span class="line">Servo arm_servos[SERVOS];   <span class="comment">// 声明SERVOS个舵机</span></span><br><span class="line"><span class="type">int</span> servo_pins[SERVOS];         <span class="comment">// 舵机要接入的主板IO口</span></span><br><span class="line"><span class="type">int</span> servo_cur_angle[SERVOS];    <span class="comment">// 舵机当前的旋转角度</span></span><br><span class="line"><span class="type">int</span> servo_min_angle[SERVOS];    <span class="comment">// 允许舵机旋转到达的最小值</span></span><br><span class="line"><span class="type">int</span> servo_max_angle[SERVOS];    <span class="comment">// 允许舵机旋转到达的最大值</span></span><br><span class="line"><span class="type">int</span> servo_init_angle[SERVOS];   <span class="comment">// 刚上电时，舵机的初始角度</span></span><br><span class="line"><span class="type">int</span> joystick_value[SERVOS];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JOYSTICK_MIN_THRESH     (300)   <span class="comment">// 摇杆ADC值的最小阈值，用于判断摇杆向哪边推动了</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JOYSTICK_MAX_THRESH     (700)   <span class="comment">// 摇杆ADC值的最大阈值，用于判断摇杆向哪边推动了</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLAW_OPEN_ANGLE     (45)    <span class="comment">// 爪子张开时的舵机角度</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLAW_CLOSE_ANGLE    (5)    <span class="comment">// 爪子闭合时的舵机角度</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLAW_SERVO_INDEX    (SERVOS-1)  <span class="comment">// 爪子舵机的序号，倒数第一个</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEARN_MAX_ACTIONS   (100)   <span class="comment">// 学习模式最多可记录的动作个数</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> learning_mode = <span class="literal">false</span>;  <span class="comment">// 是否进入学习模式？</span></span><br><span class="line"><span class="type">bool</span> repeat_mode = <span class="literal">false</span>;  <span class="comment">// 是否重复刚才学习到的动作？(配合学习模式使用)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> learn_actions[LEARN_MAX_ACTIONS][SERVOS];   <span class="comment">// 学习模式存储记录动作</span></span><br><span class="line"><span class="type">int</span> learn_action_count = <span class="number">0</span>;                     <span class="comment">// 学习模式记录了多少动作？</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXSPEED    (10)    <span class="comment">// 舵机最大旋转速度</span></span></span><br><span class="line"><span class="type">int</span> demo_speed = <span class="number">1</span>;         <span class="comment">// 1倍速、2倍速......</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JOYSTICK_LEFT_BUTTON    (2)     <span class="comment">// 左键用于学习模式</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JOYSTICK_RIGHT_BUTTON   (4)     <span class="comment">// 右键用于播放预设动作</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JOYSTICK_LED            (3)     <span class="comment">// 摇杆模块上面的LED灯，接入主板3号脚</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> has_btn_been_pressed = <span class="literal">false</span>;          <span class="comment">// 记录上次的按键状态</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  pinMode(JOYSTICK_LEFT_BUTTON, INPUT_PULLUP);      <span class="comment">// 左键用于学习模式</span></span><br><span class="line">  pinMode(JOYSTICK_RIGHT_BUTTON, INPUT_PULLUP);     <span class="comment">// 右键用于播放预设动作</span></span><br><span class="line"></span><br><span class="line">  pinMode(JOYSTICK_LED, OUTPUT);</span><br><span class="line">  digitalWrite(JOYSTICK_LED, HIGH); <span class="comment">// 亮灯</span></span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;System Running...&quot;</span>);</span><br><span class="line">  Serial.print(digitalRead(JOYSTICK_LEFT_BUTTON));      <span class="comment">//读取并串口打印按键状态</span></span><br><span class="line">  Serial.print(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">  Serial.println(digitalRead(JOYSTICK_RIGHT_BUTTON));   <span class="comment">//读取并串口打印按键状态</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bluetooth Module UART default baudrate is 9600</span></span><br><span class="line">  mySerial.begin(<span class="number">9600</span>);</span><br><span class="line">  delay(<span class="number">200</span>);</span><br><span class="line">  test_bluetooth_module();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化工作</span></span><br><span class="line">  initialization();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == digitalRead(JOYSTICK_LEFT_BUTTON))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 左键用于学习模式</span></span><br><span class="line">    learning_mode = <span class="literal">true</span>;</span><br><span class="line">    has_btn_been_pressed = <span class="literal">true</span>;  <span class="comment">// 记录有按键按下了！</span></span><br><span class="line">    learn_action_count = <span class="number">0</span>;</span><br><span class="line">    delay(<span class="number">1000</span>);</span><br><span class="line">    digitalWrite(JOYSTICK_LED, LOW);    <span class="comment">// 灭灯</span></span><br><span class="line"></span><br><span class="line">    Serial.println(<span class="string">&quot;Enter learning_mode!!&quot;</span>);    <span class="comment">// 进入学习模式</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == digitalRead(JOYSTICK_RIGHT_BUTTON))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 右键用于播放预设动作</span></span><br><span class="line">    play_demo_mode = <span class="literal">true</span>;</span><br><span class="line">    has_btn_been_pressed = <span class="literal">true</span>;  <span class="comment">// 记录有按键按下了！</span></span><br><span class="line">    Serial.println(<span class="string">&quot;Enter play_demo_mode!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始播放预设动作序列</span></span><br><span class="line">    play_demo();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 炫耀武力，爪子抓2次</span></span><br><span class="line">    cut_cut();</span><br><span class="line">    Serial.println(<span class="string">&quot;Enter Bluetooth/JoyStick Control Mode!!&quot;</span>);    <span class="comment">// 进入摇杆操控模式</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 手机APP 操控机械臂工作</span></span><br><span class="line">  move_by_bluetooth();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 摇杆模块操控机械臂工作</span></span><br><span class="line">  move_by_joystick_contrl();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 学习模式，需要和摇杆操控互相配合</span></span><br><span class="line">  learning_actions();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_bluetooth_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;\nTest Bluetooth Module: start\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> cmd[<span class="number">16</span>] = <span class="string">&quot;AT+NAME\r\n\r\n&quot;</span>;</span><br><span class="line">  <span class="type">int</span> len = <span class="built_in">strlen</span>(cmd);</span><br><span class="line">  Serial.println(cmd);</span><br><span class="line">  Serial.println(len);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len + <span class="number">1</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    mySerial.write(cmd[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  delay(<span class="number">200</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (mySerial.available())</span><br><span class="line">    &#123;</span><br><span class="line">      Serial.print(mySerial.read(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.print(<span class="string">&quot;\nTest Bluetooth Module: end\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initialization</span><span class="params">()</span> &#123;</span><br><span class="line">  servo_pins[<span class="number">0</span>] = <span class="number">11</span>;           <span class="comment">// pin 11 -- Servo base   底座舵机</span></span><br><span class="line">  servo_min_angle[<span class="number">0</span>] = <span class="number">0</span>;       <span class="comment">// 允许舵机旋转到达的最小值</span></span><br><span class="line">  servo_max_angle[<span class="number">0</span>] = <span class="number">180</span>;     <span class="comment">// 允许舵机旋转到达的最大值</span></span><br><span class="line">  servo_init_angle[<span class="number">0</span>] = <span class="number">90</span>;     <span class="comment">// 刚上电时，舵机的初始角度</span></span><br><span class="line"></span><br><span class="line">  servo_pins[<span class="number">1</span>] = <span class="number">10</span>;           <span class="comment">// 10 : Servo left   左臂舵机</span></span><br><span class="line">  servo_min_angle[<span class="number">1</span>] = <span class="number">10</span>;      <span class="comment">// 允许舵机旋转到达的最小值</span></span><br><span class="line">  servo_max_angle[<span class="number">1</span>] = <span class="number">140</span>;     <span class="comment">// 允许舵机旋转到达的最大值</span></span><br><span class="line">  servo_init_angle[<span class="number">1</span>] = <span class="number">90</span>;     <span class="comment">// 刚上电时，舵机的初始角度</span></span><br><span class="line"></span><br><span class="line">  servo_pins[<span class="number">2</span>] = <span class="number">9</span>;            <span class="comment">//  9 : Servo right  右臂舵机</span></span><br><span class="line">  servo_min_angle[<span class="number">2</span>] = <span class="number">40</span>;      <span class="comment">// 允许舵机旋转到达的最小值</span></span><br><span class="line">  servo_max_angle[<span class="number">2</span>] = <span class="number">170</span>;     <span class="comment">// 允许舵机旋转到达的最大值</span></span><br><span class="line">  servo_init_angle[<span class="number">2</span>] = <span class="number">90</span>;     <span class="comment">// 刚上电时，舵机的初始角度</span></span><br><span class="line"></span><br><span class="line">  servo_pins[<span class="number">3</span>] = <span class="number">5</span>;                        <span class="comment">//  5 : Servo claw   爪子舵机</span></span><br><span class="line">  servo_min_angle[<span class="number">3</span>] = CLAW_CLOSE_ANGLE;    <span class="comment">// 允许舵机旋转到达的最小值</span></span><br><span class="line">  servo_max_angle[<span class="number">3</span>] = CLAW_OPEN_ANGLE;     <span class="comment">// 允许舵机旋转到达的最大值</span></span><br><span class="line">  servo_init_angle[<span class="number">3</span>] = CLAW_OPEN_ANGLE;   <span class="comment">// 刚上电时，舵机的初始角度</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 学习模式清空所有动作</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; LEARN_MAX_ACTIONS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span> ; j &lt; SERVOS; j++) &#123;</span><br><span class="line">      learn_actions[i][j] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 给所有舵机设置初始角度</span></span><br><span class="line">  init_servos();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_servos</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SERVOS; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    arm_servos[i].attach(servo_pins[i], <span class="number">500</span>, <span class="number">2500</span>);      <span class="comment">// 把舵机关联到对应的PWM引脚上</span></span><br><span class="line">    arm_servos[i].write(servo_init_angle[i]); <span class="comment">// 写入舵机的初始角度</span></span><br><span class="line">    joystick_value[i] = <span class="number">0</span>;                    <span class="comment">// 摇杆ADC值初始化为0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 炫耀武力，爪子抓2次</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cut_cut</span><span class="params">()</span> &#123;</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    close_claw(<span class="literal">true</span>);</span><br><span class="line">    delay(<span class="number">150</span>);</span><br><span class="line">    close_claw(<span class="literal">false</span>);</span><br><span class="line">    delay(<span class="number">150</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制爪子开闭</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">close_claw</span><span class="params">(<span class="type">bool</span> close)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (close) &#123;</span><br><span class="line">    arm_servos[CLAW_SERVO_INDEX].write(CLAW_CLOSE_ANGLE);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    arm_servos[CLAW_SERVO_INDEX].write(CLAW_OPEN_ANGLE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">move_by_joystick_contrl</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> joy_changed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SERVOS; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 读取摇杆ADC值</span></span><br><span class="line">    <span class="comment">// A0 --&gt; joystick_value[0] --&gt; 左摇杆左右推，控制底座舵机旋转；</span></span><br><span class="line">    <span class="comment">// A1 --&gt; joystick_value[1] --&gt; 左摇杆前后推，控制左臂舵机旋转；</span></span><br><span class="line">    <span class="comment">// A2 --&gt; joystick_value[2] --&gt; 右摇杆前后推，控制右臂舵机旋转；</span></span><br><span class="line">    <span class="comment">// A3 --&gt; joystick_value[3] --&gt; 右摇杆左右推，控制爪子舵机旋转；</span></span><br><span class="line">    joystick_value[i] = analogRead(i);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="comment">// 串口打印摇杆ADC值</span></span><br><span class="line">    Serial.print(<span class="string">&quot;A[&quot;</span>);</span><br><span class="line">    Serial.print(i);</span><br><span class="line">    Serial.print(<span class="string">&quot;]=&quot;</span>);</span><br><span class="line">    Serial.print(joystick_value[i]);</span><br><span class="line">    Serial.print(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取舵机当前的旋转角度</span></span><br><span class="line">    servo_cur_angle[i] = arm_servos[i].read();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (joystick_value[i] &gt; JOYSTICK_MAX_THRESH)    <span class="comment">// 摇杆ADC值超过最大阈值</span></span><br><span class="line">    &#123;</span><br><span class="line">      joy_changed = <span class="literal">true</span>;    <span class="comment">// 摇杆被推动过了！</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (servo_cur_angle[i] &gt; servo_min_angle[i])</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 如果舵机当前角度，大于，允许舵机旋转到达的最小值，则舵机角度降低1度</span></span><br><span class="line">        --servo_cur_angle[i];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (i == CLAW_SERVO_INDEX)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 如果是爪子舵机，则直接闭合爪子</span></span><br><span class="line">        servo_cur_angle[i] = CLAW_OPEN_ANGLE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (joystick_value[i] &lt; JOYSTICK_MIN_THRESH)   <span class="comment">// 摇杆ADC值小于最小阈值</span></span><br><span class="line">    &#123;</span><br><span class="line">      joy_changed = <span class="literal">true</span>;   <span class="comment">// 摇杆被推动过了！</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (servo_cur_angle[i] &lt; servo_max_angle[i])</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 如果舵机当前角度，小于，允许舵机旋转到达的最大值，则舵机角度增加1度</span></span><br><span class="line">        ++servo_cur_angle[i];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (i == CLAW_SERVO_INDEX)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 如果是爪子舵机，则直接打开爪子</span></span><br><span class="line">        servo_cur_angle[i] = CLAW_CLOSE_ANGLE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">true</span> == joy_changed)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 只要摇杆被推动过了，就刷新一遍舵机角度: 将当前最新的舵机角度值，写入舵机</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; SERVOS; i++)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">      <span class="comment">// 串口打印舵机角度</span></span><br><span class="line">      Serial.print(<span class="string">&quot;servo[&quot;</span>);</span><br><span class="line">      Serial.print(i);</span><br><span class="line">      Serial.print(<span class="string">&quot;]=&quot;</span>);</span><br><span class="line">      Serial.print(servo_cur_angle[i]);</span><br><span class="line">      Serial.print(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      arm_servos[i].write(servo_cur_angle[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  delay(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">move_by_bluetooth</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">bool</span> joy_changed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mySerial.available())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> inByte = mySerial.read();</span><br><span class="line">    Serial.print(inByte);</span><br><span class="line">    <span class="keyword">if</span> ((inByte != (<span class="type">char</span>)<span class="number">0xFF</span>) &amp;&amp; (inByte != (<span class="type">char</span>)<span class="number">0x0A</span>) &amp;&amp; (inByte != (<span class="type">char</span>)<span class="number">0x0D</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      joy_changed = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">switch</span> (inByte)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> (servo_cur_angle[<span class="number">0</span>] &lt; servo_max_angle[<span class="number">0</span>])</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 如果舵机当前角度，小于，允许舵机旋转到达的最大值，则舵机角度增加1度</span></span><br><span class="line">              ++servo_cur_angle[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> (servo_cur_angle[<span class="number">0</span>] &gt; servo_min_angle[<span class="number">0</span>])</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 如果舵机当前角度，大于，允许舵机旋转到达的最小值，则舵机角度降低1度</span></span><br><span class="line">              --servo_cur_angle[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> (servo_cur_angle[<span class="number">1</span>] &lt; servo_max_angle[<span class="number">1</span>])</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 如果舵机当前角度，小于，允许舵机旋转到达的最大值，则舵机角度增加1度</span></span><br><span class="line">              ++servo_cur_angle[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> (servo_cur_angle[<span class="number">1</span>] &gt; servo_min_angle[<span class="number">1</span>])</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 如果舵机当前角度，大于，允许舵机旋转到达的最小值，则舵机角度降低1度</span></span><br><span class="line">              --servo_cur_angle[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// 爪子舵机，直接闭合爪子</span></span><br><span class="line">            servo_cur_angle[<span class="number">3</span>] = CLAW_CLOSE_ANGLE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">          &#123;            </span><br><span class="line">            <span class="comment">// 爪子舵机，直接打开爪子</span></span><br><span class="line">            servo_cur_angle[<span class="number">3</span>] = CLAW_OPEN_ANGLE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> (servo_cur_angle[<span class="number">2</span>] &gt; servo_min_angle[<span class="number">2</span>])</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 如果舵机当前角度，大于，允许舵机旋转到达的最小值，则舵机角度降低1度</span></span><br><span class="line">              --servo_cur_angle[<span class="number">2</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> (servo_cur_angle[<span class="number">2</span>] &lt; servo_max_angle[<span class="number">2</span>])</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 如果舵机当前角度，小于，允许舵机旋转到达的最大值，则舵机角度增加1度</span></span><br><span class="line">              ++servo_cur_angle[<span class="number">2</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            joy_changed = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">true</span> == joy_changed)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 只要手机APP摇杆被推动过了，就刷新一遍舵机角度: 将当前最新的舵机角度值，写入舵机</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; SERVOS; i++)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">      <span class="comment">// 串口打印舵机角度</span></span><br><span class="line">      Serial.print(<span class="string">&quot;servo[&quot;</span>);</span><br><span class="line">      Serial.print(i);</span><br><span class="line">      Serial.print(<span class="string">&quot;]=&quot;</span>);</span><br><span class="line">      Serial.print(servo_cur_angle[i]);</span><br><span class="line">      Serial.print(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      arm_servos[i].write(servo_cur_angle[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    move_from_to:</span></span><br><span class="line"><span class="comment">    目的是，让机械臂的2个动作之间的变化、运动、转移，更加平滑，</span></span><br><span class="line"><span class="comment">    不要让舵机瞬间完成角度切换，一方面增加舵机使用寿命，一方面机械臂工作更加自然。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">move_from_to</span><span class="params">(<span class="type">int</span> *action_from, <span class="type">int</span> *action_to)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> max_angle = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> max_steps = <span class="number">0</span>;</span><br><span class="line">  <span class="type">float</span> step_angle[SERVOS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调整机械臂的运动、转移速度</span></span><br><span class="line">  adjust_speed();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    1. 找到角度变化最大的那个舵机，算出角度变化绝对值max_angle；</span></span><br><span class="line"><span class="comment">    2. 角度变化值max_angle ÷ 舵机旋转速度demo_speed，就是舵机要运行的步数max_steps；</span></span><br><span class="line"><span class="comment">    3. 根据总步数max_steps，计算出每个舵机单步转动的角度step_angle；</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  max_angle = max(max(<span class="built_in">abs</span>(action_to[<span class="number">0</span>] - action_from[<span class="number">0</span>]), <span class="built_in">abs</span>(action_to[<span class="number">1</span>] - action_from[<span class="number">1</span>])), <span class="built_in">abs</span>(action_to[<span class="number">2</span>] - action_from[<span class="number">2</span>]));</span><br><span class="line">  max_steps = max_angle / demo_speed;</span><br><span class="line">  max_steps = max_steps &lt; <span class="number">1</span> ? <span class="number">1</span> : max_steps;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CLAW_SERVO_INDEX; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    step_angle[i] = <span class="type">float</span>(action_to[i] - action_from[i]) / <span class="type">float</span>(max_steps);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= max_steps; j++) <span class="comment">// 步数j累加</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CLAW_SERVO_INDEX; i++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 随着j慢慢增大，new_angle 会慢慢趋近于 action_to[i]，也就实现了运动平滑的效果</span></span><br><span class="line">      <span class="type">int</span> new_angle = action_from[i] + j * step_angle[i];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((new_angle &lt; servo_min_angle[i]) || (new_angle &gt; servo_max_angle[i]))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 舵机角度值超出范围，忽略</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      arm_servos[i].write(new_angle);  <span class="comment">// 将最新的角度值，写入舵机</span></span><br><span class="line">    &#125;</span><br><span class="line">    delay(<span class="number">20</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 爪子舵机的开闭动作，不需要平滑过渡，直接设置角度给舵机</span></span><br><span class="line">  arm_servos[CLAW_SERVO_INDEX].write(action_to[CLAW_SERVO_INDEX]);</span><br><span class="line">  delay(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放预设动作序列</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">play_demo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 计算总共有多少个动作？</span></span><br><span class="line">  <span class="type">int</span> counts = <span class="keyword">sizeof</span>(demo_actions) / (SERVOS * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  Serial.print(<span class="string">&quot;demo_actions counts = &quot;</span>);</span><br><span class="line">  Serial.println(counts);</span><br><span class="line"></span><br><span class="line">  move_from_to(servo_init_angle, demo_actions[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; counts - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 摇杆左右键，任何按键按下，结束播放预设动作序列</span></span><br><span class="line">      <span class="keyword">if</span> (is_btn_pressed())</span><br><span class="line">      &#123;</span><br><span class="line">        learning_mode = <span class="literal">false</span>;</span><br><span class="line">        repeat_mode = <span class="literal">false</span>;</span><br><span class="line">        play_demo_mode = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 机械臂从当前动作，运动、转移至下一个动作</span></span><br><span class="line">      move_from_to(demo_actions[i], demo_actions[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整机械臂的运动、转移速度</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">adjust_speed</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 任何一个摇杆推动任何一个方向，都可以调整速度</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SERVOS; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (analogRead(i) &gt; JOYSTICK_MAX_THRESH) demo_speed++; <span class="comment">// 速度加</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (analogRead(i) &lt; JOYSTICK_MIN_THRESH) demo_speed--; <span class="comment">// 速度减</span></span><br><span class="line">  &#125;</span><br><span class="line">  demo_speed = demo_speed &lt; <span class="number">1</span> ? <span class="number">1</span> : demo_speed;</span><br><span class="line">  demo_speed = demo_speed &gt; MAXSPEED ? MAXSPEED : demo_speed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_btn_pressed</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="literal">false</span> == has_btn_been_pressed) &amp;&amp; ((<span class="number">0</span> == digitalRead(JOYSTICK_RIGHT_BUTTON)) || (<span class="number">0</span> == digitalRead(JOYSTICK_LEFT_BUTTON))))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 如果上次没有按键按下，而现在左键或者右键按下了，则认为现在确实有按键按下了</span></span><br><span class="line">    has_btn_been_pressed = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="number">1</span> == digitalRead(JOYSTICK_RIGHT_BUTTON)) &amp;&amp; (<span class="number">1</span> == digitalRead(JOYSTICK_LEFT_BUTTON)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 如果左右键都没有按下，则认为确实没有按键按下</span></span><br><span class="line">    has_btn_been_pressed = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>机械臂使用的是arduino生态，主要使用了arduinoUNO这个板子，同时也加装了蓝牙模块，代码封装函数和stm32略有不同。</p><h2 id="2-8滤波器"><a href="#2-8滤波器" class="headerlink" title="2.8滤波器"></a>2.8滤波器</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">updateFilter</span><span class="params">(<span class="type">int16_t</span>* buffer, <span class="type">int16_t</span> newValue)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = FILTER_SIZE - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        buffer[i] = buffer[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    buffer[<span class="number">0</span>] = newValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int16_t</span> <span class="title function_">getFilteredValue</span><span class="params">(<span class="type">int16_t</span>* buffer)</span> &#123;</span><br><span class="line">    <span class="comment">// 计算缓冲区内所有值的平均值</span></span><br><span class="line">    <span class="type">int32_t</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; FILTER_SIZE; i++) &#123;</span><br><span class="line">        sum += buffer[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum / FILTER_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>加入滤波器相关程序的考虑如下：</strong></p><p><strong>1.减少控制器的灵敏度：</strong> 滤波器可以减少PID控制器对高频噪声和干扰的敏感度。这有助于防止PID控制器对系统中不必要的快速变化作出响应，从而提高系统的稳定性。</p><p><strong>2.滤波测量信号：</strong> 在PID控制中，测量信号可能受到噪声的影响。通过对测量信号应用滤波器，可以改善系统对实际状态的感知，提高控制性能。</p><p><strong>3.避免控制器振荡：</strong> 滤波器有助于减小系统中可能引起控制器振荡的高频成分。这有助于防止控制器在某些条件下产生不稳定的振荡。</p><p>后来经过测试证明，我们的设计是有很大效果的，极大程度上降低了红外对管物种多样性的阴间影响</p><h1 id="3-总结及反思"><a href="#3-总结及反思" class="headerlink" title="3. 总结及反思"></a>3. 总结及反思</h1><h2 id="3-1-软件方面"><a href="#3-1-软件方面" class="headerlink" title="3.1 软件方面"></a>3.1 软件方面</h2><ul><li>由于缺乏经验和想法，在最开始的直接控制上浪费了很多时间（and金钱），当代码完成后，可以发现很多封装其实是没有必要的，而且会降低循迹的反应速度和稳定性。</li><li>在封装控制函数的过程中出现了“各自为政的现象”，造成了大量的冗余。直到后来才发现有些参数几乎是可以复用的，完全可以通过定义少数的宏来节省大量空间，并增强代码的可读性，提高运行效率。</li><li>我们在最终的代码里尝试定义了一个类似于摩擦系数的宏，所有的参数可以根据这个宏计算来调节，理论上只要知道比赛场地的路况等信息就可以一键调节所有的速度、角度等参数，从而节省了大量的调参时间。但是在最终的结果中我们发现这种定义方式并不足以满足各种复杂情况，主要因素如下：</li></ul><p>1.各个电机和红外对管的性能不同，统一调控会导致系统整体的兼容性和稳定性下降。</p><p>2.路况复杂的情况下，盲目地追求减少调参时间是不可取的。</p><p>因此，虽然宏的使用是一个很好的尝试，但在实践中，我们也意识到需要更为灵活和细致的参数调整，以适应不同的实际情况。这一过程是一个不断优化和润色代码的过程，通过反复实验和调整，逐步找到最优的参数配置。这也是在机器人控制领域中常见的挑战之一，需要不断学习和改进。</p><h2 id="3-2-硬件方面"><a href="#3-2-硬件方面" class="headerlink" title="3.2 硬件方面"></a>3.2 硬件方面</h2><ul><li>由于对新生板的使用不够熟悉，我们在参赛前最后一天先后损坏了数块板子的电源等模块，为正式比赛优化代码造成了很恶劣的影响。</li><li>由于对比赛规则的不熟悉，在选购机械臂时出现了严重失误，机械臂的抬升高度不足以支持能量块的投放，故在正式比赛时我们放弃了给机械臂通电，避免电能的无效浪费。</li><li>面对IO口稀少的情况，我们使用的焊接杜邦线的骚操作，我们承认这一行为给我们减少了很多麻烦，但是电流的减弱也曾一度让我们的电机面临驱动力不足等问题，好在可以通过更改PWM占空比缓解这一问题。</li></ul><h2 id="3-3-工程经验方面"><a href="#3-3-工程经验方面" class="headerlink" title="3.3 工程经验方面"></a>3.3 工程经验方面</h2><ul><li>工程经验的缺少使我们分工不够明确，效率不够高效。好在大家目标一致，最终较为圆满地完成了部分任务，离不开所有队员的倾力合作和集思广益。</li></ul><h1 id="4-感悟"><a href="#4-感悟" class="headerlink" title="4.感悟"></a>4.感悟</h1><ul><li><p>肝了一个月，这是大上学以来第一次独立做出可使用的工程（<em>虽然垃圾得一批</em>），学到了很多以前自认为要大三甚至大四才能碰到的知识，像L298电驱，PWM波占空比的调节，PID控制算法，各种路口判断的设计，在现场实地修（乱）改参数等，碰到了各种各样逆天且玄学的问题，such as芯片的神奇短路，电源模块莫名暴毙，ADC接口的梦幻联动，（至今工位上还摆放着四块待救治的板子）。——<strong>特此衷心感谢硬件陈学长的力挽狂澜</strong></p></li><li><p>与此同时明显感觉到C语言的能力得到了大幅度提升（尤其时造轮子的能力仿佛登峰造极），还练就了一身从屎里找吃的硬能力。</p><p>本篇博客就当成一个里程碑吧，纪念这疯狂熬夜的一个月（以及未来将要熬的无数个月），同时感谢718的各位学长（不）厌其烦的讲解和帮助。</p></li></ul><p><strong>外链：<a target="_blank" rel="noopener" href="https://www.yuque.com/quanzhi-ndfvt/azx1dc/udzvfrcvol51mwr4?singleDoc#">https://www.yuque.com/quanzhi-ndfvt/azx1dc/udzvfrcvol51mwr4?singleDoc#</a> 《2023校内赛技术报告》</strong></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.zuquanzhi.top">ZU Quanzhi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.zuquanzhi.top/2023/11/27/24084/">https://blog.zuquanzhi.top/2023/11/27/24084/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.zuquanzhi.top" target="_blank">全之の博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AF%BB%E8%BF%B9%E8%BD%A6-%E8%93%9D%E7%89%99/">寻迹车 蓝牙</a></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/11/27/46763/" title="结构体编程"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">结构体编程</div></div></a></div><div class="next-post pull-right"><a href="/2023/11/23/3448/" title="LeetCode0498"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LeetCode0498</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/head.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">ZU Quanzhi</div><div class="author-info__description">My personal blog is a lively corner where I document my journey of self-improvement, continuous learning, and share the highs and lows of my life's adventures. It's a digital diary where I enthusiastically capture the steps I take to better myself, the invaluable lessons I've learned, and a platform to express my thoughts and experiences.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zuquanzhi"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zuquanzhi" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a><a class="social-icon" href="/zuweicun@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#4a7dbe"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color:#f60"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Follow 再看 ，养成习惯</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%A1%AC%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">1. 硬件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E7%BA%A2%E5%A4%96%E5%AF%B9%E7%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 红外对管</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E5%BE%AA%E8%BF%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1.1 循迹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-%E8%B7%AF%E5%8F%A3%E5%88%A4%E6%96%AD%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.1.2 路口判断逻辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%9C%BA%E6%A2%B0%E8%87%82"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 机械臂</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E8%BD%AF%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text">2. 软件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AE%8F%E5%8F%8A%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 宏及全局变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%B8%BB%E5%87%BD%E6%95%B0%E5%8F%8A%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 主函数及初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-PID"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 PID</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-PID%E4%BB%A3%E7%A0%81"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 PID代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-1-PID%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">2.3.1.1 PID基本原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-2-%E6%9C%80%E7%BB%88%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">2.3.1.2 最终代码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E8%B7%AF%E5%8F%A3%E8%AF%86%E5%88%AB"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 路口识别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E8%93%9D%E7%89%99"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 蓝牙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E7%94%B5%E6%9C%BA%E6%8E%A7%E5%88%B6"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 电机控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7%E6%9C%BA%E6%A2%B0%E8%87%82"><span class="toc-number">2.7.</span> <span class="toc-text">2.7机械臂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="toc-number">2.8.</span> <span class="toc-text">2.8滤波器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%80%BB%E7%BB%93%E5%8F%8A%E5%8F%8D%E6%80%9D"><span class="toc-number">3.</span> <span class="toc-text">3. 总结及反思</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%BD%AF%E4%BB%B6%E6%96%B9%E9%9D%A2"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 软件方面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%A1%AC%E4%BB%B6%E6%96%B9%E9%9D%A2"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 硬件方面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%B7%A5%E7%A8%8B%E7%BB%8F%E9%AA%8C%E6%96%B9%E9%9D%A2"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 工程经验方面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%84%9F%E6%82%9F"><span class="toc-number">4.</span> <span class="toc-text">4.感悟</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/27/44434/" title="gin的中间件机制"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.loliapi.com/acg?89" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="gin的中间件机制"></a><div class="content"><a class="title" href="/2025/09/27/44434/" title="gin的中间件机制">gin的中间件机制</a><time datetime="2025-09-27T07:19:44.000Z" title="发表于 2025-09-27 15:19:44">2025-09-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/59604/" title="深入解析Go中Slice底层实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.loliapi.com/acg?29" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="深入解析Go中Slice底层实现"></a><div class="content"><a class="title" href="/2025/09/22/59604/" title="深入解析Go中Slice底层实现">深入解析Go中Slice底层实现</a><time datetime="2025-09-22T05:17:44.000Z" title="发表于 2025-09-22 13:17:44">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/17/7375/" title="搭建Docker私有镜像站"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.loliapi.com/acg?67" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="搭建Docker私有镜像站"></a><div class="content"><a class="title" href="/2025/09/17/7375/" title="搭建Docker私有镜像站">搭建Docker私有镜像站</a><time datetime="2025-09-17T10:44:21.000Z" title="发表于 2025-09-17 18:44:21">2025-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/17/63383/" title="cpolar实现内网穿透"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.loliapi.com/acg?34" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="cpolar实现内网穿透"></a><div class="content"><a class="title" href="/2025/09/17/63383/" title="cpolar实现内网穿透">cpolar实现内网穿透</a><time datetime="2025-09-17T10:30:30.000Z" title="发表于 2025-09-17 18:30:30">2025-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/11/43814/" title="Agent时代基础设施--MCP协议介绍"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgapi.jinghuashang.cn/random?1213" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Agent时代基础设施--MCP协议介绍"></a><div class="content"><a class="title" href="/2025/04/11/43814/" title="Agent时代基础设施--MCP协议介绍">Agent时代基础设施--MCP协议介绍</a><time datetime="2025-04-10T16:00:06.000Z" title="发表于 2025-04-11 00:00:06">2025-04-11</time></div></div></div></div></div></div></main><footer id="footer" style="background:url(/img/footer_bg.jpg)"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">百忙之中，下一步闲棋是很有必要的</p><div class="bg-ad"><div>畏首畏尾，身余几何？</div><div class="btn-xz-box"></div></div></div></div></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/tw_cn.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/search/local-search.min.js"></script></div></div></body></html>